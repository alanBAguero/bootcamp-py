{"ast":null,"code":"function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  Object.defineProperty(Constructor, \"prototype\", {\n    writable: false\n  });\n  return Constructor;\n}\nimport { Uploader } from \"src/decidim/direct_uploads/uploader\";\nimport { truncateFilename, checkTitles, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";\n\n// This class handles logic inside upload modal, but since modal is not inside the form\n// logic here moves \"upload items\" / hidden inputs to form.\nvar UploadModal = /*#__PURE__*/function () {\n  function UploadModal(button) {\n    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    _classCallCheck(this, UploadModal);\n    // Button that opens the modal.\n    this.button = button;\n\n    // The provided options contains the options passed from the view in the\n    // `data-upload` attribute as a JSON.\n    var providedOptions = {};\n    try {\n      // The providedOptions can contain the following keys:\n      // - addAttribute - Field name / attribute of resource (e.g. avatar)\n      // - resourceName - The resource to which the attribute belongs (e.g. user)\n      // - resourceClass - Ruby class of the resource (e.g. Decidim::User)\n      // - optional - Defines if file is optional\n      // - multiple - Defines if multiple files can be uploaded\n      // - titled - Defines if file(s) can have titles\n      // - maxFileSize - Defines maximum file size in bytes\n      // - formObjectClass - Class of the current form object (e.g. Decidim::AccountForm)\n      providedOptions = JSON.parse(button.dataset.upload);\n    } catch (_e) {\n      // Don't care about the parse errors, just skip the provided options.\n    }\n    this.options = Object.assign(providedOptions, options);\n    this.name = this.button.name;\n    this.modal = document.querySelector(\"#\".concat(button.dataset.open));\n    this.saveButton = this.modal.querySelector(\"button.add-file-\".concat(this.name));\n    this.attachmentCounter = 0;\n    this.dropZoneEnabled = true;\n    this.modalTitle = this.modal.querySelector(\".reveal__title\");\n    this.uploadItems = this.modal.querySelector(\".upload-items\");\n    this.locales = JSON.parse(this.uploadItems.dataset.locales);\n    this.dropZone = this.modal.querySelector(\".dropzone\");\n    this.input = this.dropZone.querySelector(\"input\");\n    this.uploadContainer = document.querySelector(\".upload-container-for-\".concat(this.name));\n    this.activeAttachments = this.uploadContainer.querySelector(\".active-uploads\");\n    this.trashCan = this.createTrashCan();\n  }\n  _createClass(UploadModal, [{\n    key: \"uploadFile\",\n    value: function uploadFile(file) {\n      var _this = this;\n      if (!this.dropZoneEnabled) {\n        return;\n      }\n      var title = file.name.split(\".\")[0].slice(0, 31);\n      var uploadItem = this.createUploadItem(file.name, title, \"init\");\n      var uploader = new Uploader(this, uploadItem, {\n        file: file,\n        url: this.input.dataset.directUploadUrl,\n        attachmentName: file.name\n      });\n      if (uploader.fileTooBig) {\n        return;\n      }\n      uploader.upload.create(function (error, blob) {\n        if (error) {\n          uploadItem.dataset.state = \"error\";\n          var progressBar = uploadItem.querySelector(\".progress-bar\");\n          progressBar.classList.add(\"filled\");\n          progressBar.innerHTML = _this.locales.error;\n          console.error(error);\n        } else {\n          var ordinalNumber = _this.getOrdinalNumber();\n          var attachmentDetails = document.createElement(\"div\");\n          attachmentDetails.classList.add(\"attachment-details\");\n          attachmentDetails.dataset.filename = file.name;\n          var titleAndFileNameSpan = document.createElement(\"span\");\n          titleAndFileNameSpan.style.display = \"none\";\n          attachmentDetails.appendChild(titleAndFileNameSpan);\n          var hiddenBlobField = createHiddenInput(null, null, blob.signed_id);\n          if (_this.options.titled) {\n            hiddenBlobField.name = \"\".concat(_this.options.resourceName, \"[\").concat(_this.options.addAttribute, \"][\").concat(ordinalNumber, \"][file]\");\n          } else {\n            hiddenBlobField.name = \"\".concat(_this.options.resourceName, \"[\").concat(_this.options.addAttribute, \"]\");\n          }\n          if (_this.options.titled) {\n            var hiddenTitleField = createHiddenInput(\"hidden-title\", \"\".concat(_this.options.resourceName, \"[\").concat(_this.options.addAttribute, \"][\").concat(ordinalNumber, \"][title]\"), title);\n            titleAndFileNameSpan.innerHTML = \"\".concat(title, \" (\").concat(file.name, \")\");\n            attachmentDetails.appendChild(hiddenTitleField);\n          } else {\n            titleAndFileNameSpan.innerHTML = file.name;\n          }\n          if (!_this.options.multiple) {\n            _this.cleanTrashCan();\n          }\n          attachmentDetails.appendChild(hiddenBlobField);\n          uploadItem.appendChild(attachmentDetails);\n          uploader.validate(blob.signed_id);\n        }\n      });\n      this.updateDropZone();\n    }\n  }, {\n    key: \"getOrdinalNumber\",\n    value: function getOrdinalNumber() {\n      var nextOrdinalNumber = this.attachmentCounter;\n      this.attachmentCounter += 1;\n      return nextOrdinalNumber;\n    }\n  }, {\n    key: \"updateDropZone\",\n    value: function updateDropZone() {\n      if (this.options.multiple) {\n        return;\n      }\n      if (this.uploadItems.children.length > 0) {\n        this.dropZone.classList.add(\"disabled\");\n        this.dropZoneEnabled = false;\n        this.input.disabled = true;\n      } else {\n        this.dropZone.classList.remove(\"disabled\");\n        this.dropZoneEnabled = true;\n        this.input.disabled = false;\n      }\n    }\n  }, {\n    key: \"createUploadItem\",\n    value: function createUploadItem(fileName, title, state) {\n      var _fileNameSpan$classLi,\n        _this2 = this;\n      var wrapper = document.createElement(\"div\");\n      wrapper.classList.add(\"upload-item\");\n      wrapper.setAttribute(\"data-filename\", fileName);\n      var firstRow = document.createElement(\"div\");\n      var secondRow = document.createElement(\"div\");\n      var thirdRow = document.createElement(\"div\");\n      firstRow.classList.add(\"row\", \"upload-item-first-row\");\n      secondRow.classList.add(\"row\", \"upload-item-second-row\");\n      thirdRow.classList.add(\"row\", \"upload-item-third-row\");\n      var fileNameSpan = document.createElement(\"span\");\n      var fileNameSpanClasses = [\"columns\", \"file-name-span\"];\n      if (this.options.titled) {\n        fileNameSpanClasses.push(\"small-4\", \"medium-5\");\n      } else {\n        fileNameSpanClasses.push(\"small-12\");\n      }\n      (_fileNameSpan$classLi = fileNameSpan.classList).add.apply(_fileNameSpan$classLi, fileNameSpanClasses);\n      fileNameSpan.innerHTML = truncateFilename(fileName);\n      var progressBar = document.createElement(\"div\");\n      progressBar.classList.add(\"progress-bar\");\n      if (state) {\n        if (state === \"validated\") {\n          progressBar.innerHTML = this.locales.uploaded;\n        } else {\n          progressBar.innerHTML = \"0%\";\n          progressBar.style.width = \"15%\";\n        }\n        wrapper.dataset.state = state;\n      }\n      var progressBarBorder = document.createElement(\"div\");\n      progressBarBorder.classList.add(\"progress-bar-border\");\n      progressBarBorder.appendChild(progressBar);\n      var progressBarWrapper = document.createElement(\"div\");\n      progressBarWrapper.classList.add(\"columns\", \"progress-bar-wrapper\");\n      progressBarWrapper.appendChild(progressBarBorder);\n      if (this.options.titled) {\n        progressBarWrapper.classList.add(\"small-4\", \"medium-5\");\n      } else {\n        progressBarWrapper.classList.add(\"small-10\");\n      }\n      var errorList = document.createElement(\"ul\");\n      errorList.classList.add(\"upload-errors\");\n      var removeButton = document.createElement(\"button\");\n      removeButton.classList.add(\"columns\", \"small-3\", \"medium-2\", \"remove-upload-item\");\n      removeButton.innerHTML = \"&times; \".concat(this.locales.remove);\n      removeButton.addEventListener(\"click\", function (event) {\n        event.preventDefault();\n        var item = _this2.uploadItems.querySelector(\"[data-filename='\".concat(fileName, \"']\"));\n        _this2.trashCan.append(item);\n        _this2.updateDropZone();\n      });\n      var titleAndFileNameSpan = document.createElement(\"span\");\n      titleAndFileNameSpan.classList.add(\"columns\", \"small-5\", \"title-and-filename-span\");\n      titleAndFileNameSpan.innerHTML = \"\".concat(title, \" (\").concat(truncateFilename(fileName), \")\");\n      firstRow.appendChild(fileNameSpan);\n      secondRow.appendChild(progressBarWrapper);\n      thirdRow.appendChild(errorList);\n      var titleInputContainer = null;\n      if (this.options.titled) {\n        var titleInput = document.createElement(\"input\");\n        titleInput.classList.add(\"attachment-title\");\n        titleInput.type = \"text\";\n        titleInput.value = title;\n        titleInput.addEventListener(\"input\", function (event) {\n          event.preventDefault();\n          checkTitles(_this2.uploadItems, _this2.saveButton);\n        });\n        titleInputContainer = document.createElement(\"div\");\n        titleInputContainer.classList.add(\"columns\", \"small-5\", \"title-input-container\");\n        titleInputContainer.appendChild(titleInput);\n        var noTitleErrorSpan = document.createElement(\"span\");\n        noTitleErrorSpan.classList.add(\"form-error\", \"no-title-error\");\n        noTitleErrorSpan.role = \"alert\";\n        noTitleErrorSpan.innerHTML = this.locales.title_required;\n        titleInputContainer.appendChild(noTitleErrorSpan);\n        var titleLabelSpan = document.createElement(\"span\");\n        titleLabelSpan.classList.add(\"title-label-span\");\n        titleLabelSpan.innerHTML = this.locales.title;\n        var titleContainer = document.createElement(\"div\");\n        titleContainer.classList.add(\"columns\", \"small-8\", \"medium-7\", \"title-container\");\n        titleContainer.appendChild(titleLabelSpan);\n        firstRow.appendChild(titleContainer);\n        secondRow.appendChild(titleInputContainer);\n      }\n      secondRow.appendChild(removeButton);\n      wrapper.appendChild(firstRow);\n      wrapper.appendChild(secondRow);\n      wrapper.appendChild(thirdRow);\n      this.uploadItems.appendChild(wrapper);\n      return wrapper;\n    }\n  }, {\n    key: \"updateAddAttachmentsButton\",\n    value: function updateAddAttachmentsButton() {\n      if (this.activeAttachments.children.length === 0) {\n        this.button.innerHTML = this.modalTitle.dataset.addlabel;\n      } else {\n        this.button.innerHTML = this.modalTitle.dataset.editlabel;\n      }\n    }\n  }, {\n    key: \"createTrashCan\",\n    value: function createTrashCan() {\n      var trashCan = document.createElement(\"div\");\n      trashCan.classList.add(\"trash-can\");\n      trashCan.style.display = \"none\";\n      this.uploadItems.parentElement.appendChild(trashCan);\n      return trashCan;\n    }\n  }, {\n    key: \"cleanTrashCan\",\n    value: function cleanTrashCan() {\n      var _this3 = this;\n      Array.from(this.trashCan.children).forEach(function (item) {\n        var fileName = item.dataset.filename;\n        var activeAttachment = _this3.activeAttachments.querySelector(\"div[data-filename='\".concat(fileName, \"']\"));\n        if (activeAttachment) {\n          activeAttachment.remove();\n        }\n        item.remove();\n      });\n    }\n  }]);\n  return UploadModal;\n}();\nexport { UploadModal as default };","map":{"version":3,"mappings":"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","names":["Uploader","truncateFilename","checkTitles","createHiddenInput","UploadModal","button","options","_classCallCheck","providedOptions","JSON","parse","dataset","upload","_e","Object","assign","name","modal","document","querySelector","open","saveButton","attachmentCounter","dropZoneEnabled","modalTitle","uploadItems","locales","dropZone","input","uploadContainer","activeAttachments","trashCan","createTrashCan","_createClass","key","value","file","title","split","slice","uploadItem","createUploadItem","uploader","url","directUploadUrl","attachmentName","fileTooBig","create","error","blob","state","progressBar","classList","add","innerHTML","_this","console","ordinalNumber","getOrdinalNumber","attachmentDetails","createElement","filename","titleAndFileNameSpan","style","display","appendChild","hiddenBlobField","signed_id","titled","resourceName","addAttribute","hiddenTitleField","multiple","cleanTrashCan","validate","updateDropZone","nextOrdinalNumber","children","length","disabled","remove","fileName","_this2","wrapper","setAttribute","firstRow","secondRow","thirdRow","fileNameSpan","fileNameSpanClasses","push","uploaded","width","progressBarBorder","progressBarWrapper","errorList","removeButton","addEventListener","event","preventDefault","item","append","titleInputContainer","titleInput","type","noTitleErrorSpan","role","title_required","titleLabelSpan","titleContainer","addlabel","editlabel","parentElement","Array","from","forEach","activeAttachment","_this3"],"sources":["/home/alan/.rvm/gems/ruby-3.0.3/gems/decidim-core-0.27.0/app/packs/src/decidim/direct_uploads/upload_modal.js"],"sourcesContent":["import { Uploader } from \"src/decidim/direct_uploads/uploader\";\nimport { truncateFilename, checkTitles, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";\n\n// This class handles logic inside upload modal, but since modal is not inside the form\n// logic here moves \"upload items\" / hidden inputs to form.\nexport default class UploadModal {\n  constructor(button, options = {}) {\n    // Button that opens the modal.\n    this.button = button;\n\n    // The provided options contains the options passed from the view in the\n    // `data-upload` attribute as a JSON.\n    let providedOptions = {};\n    try {\n      // The providedOptions can contain the following keys:\n      // - addAttribute - Field name / attribute of resource (e.g. avatar)\n      // - resourceName - The resource to which the attribute belongs (e.g. user)\n      // - resourceClass - Ruby class of the resource (e.g. Decidim::User)\n      // - optional - Defines if file is optional\n      // - multiple - Defines if multiple files can be uploaded\n      // - titled - Defines if file(s) can have titles\n      // - maxFileSize - Defines maximum file size in bytes\n      // - formObjectClass - Class of the current form object (e.g. Decidim::AccountForm)\n      providedOptions = JSON.parse(button.dataset.upload);\n    } catch (_e) {\n      // Don't care about the parse errors, just skip the provided options.\n    }\n\n    this.options = Object.assign(providedOptions, options)\n\n    this.name = this.button.name;\n    this.modal = document.querySelector(`#${button.dataset.open}`);\n    this.saveButton = this.modal.querySelector(`button.add-file-${this.name}`);\n    this.attachmentCounter = 0;\n    this.dropZoneEnabled = true;\n    this.modalTitle = this.modal.querySelector(\".reveal__title\");\n    this.uploadItems = this.modal.querySelector(\".upload-items\");\n    this.locales = JSON.parse(this.uploadItems.dataset.locales);\n    this.dropZone = this.modal.querySelector(\".dropzone\");\n    this.input = this.dropZone.querySelector(\"input\");\n    this.uploadContainer = document.querySelector(`.upload-container-for-${this.name}`);\n    this.activeAttachments = this.uploadContainer.querySelector(\".active-uploads\");\n    this.trashCan = this.createTrashCan();\n  }\n\n  uploadFile(file) {\n    if (!this.dropZoneEnabled) {\n      return;\n    }\n\n    const title = file.name.split(\".\")[0].slice(0, 31);\n    const uploadItem = this.createUploadItem(file.name, title, \"init\");\n    const uploader = new Uploader(this, uploadItem, {\n      file: file,\n      url: this.input.dataset.directUploadUrl,\n      attachmentName: file.name\n    });\n    if (uploader.fileTooBig) {\n      return;\n    }\n\n    uploader.upload.create((error, blob) => {\n      if (error) {\n        uploadItem.dataset.state = \"error\";\n        const progressBar = uploadItem.querySelector(\".progress-bar\");\n        progressBar.classList.add(\"filled\");\n        progressBar.innerHTML = this.locales.error;\n        console.error(error);\n      } else {\n        const ordinalNumber = this.getOrdinalNumber();\n\n        const attachmentDetails = document.createElement(\"div\");\n        attachmentDetails.classList.add(\"attachment-details\");\n        attachmentDetails.dataset.filename = file.name;\n        const titleAndFileNameSpan = document.createElement(\"span\");\n        titleAndFileNameSpan.style.display = \"none\";\n        attachmentDetails.appendChild(titleAndFileNameSpan);\n\n        const hiddenBlobField = createHiddenInput(null, null, blob.signed_id);\n        if (this.options.titled) {\n          hiddenBlobField.name = `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][file]`;\n        } else {\n          hiddenBlobField.name = `${this.options.resourceName}[${this.options.addAttribute}]`;\n        }\n\n        if (this.options.titled) {\n          const hiddenTitleField = createHiddenInput(\"hidden-title\", `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]`, title);\n          titleAndFileNameSpan.innerHTML = `${title} (${file.name})`;\n          attachmentDetails.appendChild(hiddenTitleField);\n        } else {\n          titleAndFileNameSpan.innerHTML = file.name;\n        }\n\n        if (!this.options.multiple) {\n          this.cleanTrashCan();\n        }\n\n        attachmentDetails.appendChild(hiddenBlobField);\n        uploadItem.appendChild(attachmentDetails);\n        uploader.validate(blob.signed_id);\n      }\n    });\n    this.updateDropZone();\n  }\n\n  getOrdinalNumber() {\n    const nextOrdinalNumber = this.attachmentCounter;\n    this.attachmentCounter += 1;\n    return nextOrdinalNumber;\n  }\n\n  updateDropZone() {\n    if (this.options.multiple) {\n      return;\n    }\n\n    if (this.uploadItems.children.length > 0) {\n      this.dropZone.classList.add(\"disabled\");\n      this.dropZoneEnabled = false;\n      this.input.disabled = true;\n    } else {\n      this.dropZone.classList.remove(\"disabled\");\n      this.dropZoneEnabled = true;\n      this.input.disabled = false;\n    }\n  }\n\n  createUploadItem(fileName, title, state) {\n    const wrapper = document.createElement(\"div\");\n    wrapper.classList.add(\"upload-item\");\n    wrapper.setAttribute(\"data-filename\", fileName);\n\n    const firstRow = document.createElement(\"div\");\n    const secondRow = document.createElement(\"div\");\n    const thirdRow = document.createElement(\"div\");\n    firstRow.classList.add(\"row\", \"upload-item-first-row\");\n    secondRow.classList.add(\"row\", \"upload-item-second-row\");\n    thirdRow.classList.add(\"row\", \"upload-item-third-row\");\n\n    const fileNameSpan = document.createElement(\"span\");\n    let fileNameSpanClasses = [\"columns\", \"file-name-span\"];\n    if (this.options.titled) {\n      fileNameSpanClasses.push(\"small-4\", \"medium-5\");\n    } else {\n      fileNameSpanClasses.push(\"small-12\");\n    }\n    fileNameSpan.classList.add(...fileNameSpanClasses);\n    fileNameSpan.innerHTML = truncateFilename(fileName);\n\n    const progressBar = document.createElement(\"div\");\n    progressBar.classList.add(\"progress-bar\");\n    if (state) {\n      if (state === \"validated\") {\n        progressBar.innerHTML = this.locales.uploaded;\n      } else {\n        progressBar.innerHTML = \"0%\";\n        progressBar.style.width = \"15%\";\n      }\n      wrapper.dataset.state = state;\n    }\n\n    const progressBarBorder = document.createElement(\"div\");\n    progressBarBorder.classList.add(\"progress-bar-border\");\n    progressBarBorder.appendChild(progressBar);\n\n    const progressBarWrapper = document.createElement(\"div\");\n    progressBarWrapper.classList.add(\"columns\", \"progress-bar-wrapper\");\n    progressBarWrapper.appendChild(progressBarBorder);\n    if (this.options.titled) {\n      progressBarWrapper.classList.add(\"small-4\", \"medium-5\");\n    } else {\n      progressBarWrapper.classList.add(\"small-10\");\n    }\n\n    const errorList = document.createElement(\"ul\");\n    errorList.classList.add(\"upload-errors\");\n\n    const removeButton = document.createElement(\"button\");\n    removeButton.classList.add(\"columns\", \"small-3\", \"medium-2\", \"remove-upload-item\");\n    removeButton.innerHTML = `&times; ${this.locales.remove}`;\n    removeButton.addEventListener((\"click\"), (event) => {\n      event.preventDefault();\n      const item = this.uploadItems.querySelector(`[data-filename='${fileName}']`);\n      this.trashCan.append(item);\n      this.updateDropZone();\n    })\n\n    const titleAndFileNameSpan = document.createElement(\"span\");\n    titleAndFileNameSpan.classList.add(\"columns\", \"small-5\", \"title-and-filename-span\");\n    titleAndFileNameSpan.innerHTML = `${title} (${truncateFilename(fileName)})`;\n\n    firstRow.appendChild(fileNameSpan);\n    secondRow.appendChild(progressBarWrapper);\n    thirdRow.appendChild(errorList);\n\n    let titleInputContainer = null;\n    if (this.options.titled) {\n      const titleInput = document.createElement(\"input\");\n      titleInput.classList.add(\"attachment-title\");\n      titleInput.type = \"text\";\n      titleInput.value = title;\n      titleInput.addEventListener(\"input\", (event) => {\n        event.preventDefault();\n        checkTitles(this.uploadItems, this.saveButton);\n      })\n      titleInputContainer = document.createElement(\"div\");\n      titleInputContainer.classList.add(\"columns\", \"small-5\", \"title-input-container\");\n      titleInputContainer.appendChild(titleInput);\n\n      const noTitleErrorSpan = document.createElement(\"span\");\n      noTitleErrorSpan.classList.add(\"form-error\", \"no-title-error\");\n      noTitleErrorSpan.role = \"alert\";\n      noTitleErrorSpan.innerHTML = this.locales.title_required;\n      titleInputContainer.appendChild(noTitleErrorSpan);\n\n      const titleLabelSpan = document.createElement(\"span\");\n      titleLabelSpan.classList.add(\"title-label-span\");\n      titleLabelSpan.innerHTML = this.locales.title;\n\n      const titleContainer = document.createElement(\"div\");\n      titleContainer.classList.add(\"columns\", \"small-8\", \"medium-7\", \"title-container\");\n      titleContainer.appendChild(titleLabelSpan);\n      firstRow.appendChild(titleContainer);\n      secondRow.appendChild(titleInputContainer);\n    }\n\n    secondRow.appendChild(removeButton);\n\n    wrapper.appendChild(firstRow);\n    wrapper.appendChild(secondRow);\n    wrapper.appendChild(thirdRow);\n\n    this.uploadItems.appendChild(wrapper);\n\n    return wrapper;\n  }\n\n  updateAddAttachmentsButton() {\n    if (this.activeAttachments.children.length === 0) {\n      this.button.innerHTML = this.modalTitle.dataset.addlabel;\n    } else {\n      this.button.innerHTML = this.modalTitle.dataset.editlabel;\n    }\n  }\n\n  createTrashCan() {\n    const trashCan =  document.createElement(\"div\");\n    trashCan.classList.add(\"trash-can\");\n    trashCan.style.display = \"none\";\n    this.uploadItems.parentElement.appendChild(trashCan);\n    return trashCan;\n  }\n\n  cleanTrashCan() {\n    Array.from(this.trashCan.children).forEach((item) => {\n      const fileName = item.dataset.filename;\n      const activeAttachment = this.activeAttachments.querySelector(`div[data-filename='${fileName}']`);\n      if (activeAttachment) {\n        activeAttachment.remove();\n      }\n      item.remove();\n    })\n  }\n}\n"]},"metadata":{},"sourceType":"module"}